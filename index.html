<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Collective | Unified Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F0F0F0; color: #000; overflow: hidden; height: 100%; position: fixed; width: 100%; -webkit-font-smoothing: antialiased; }
        .heading-font { font-family: 'Space Grotesk', sans-serif; }
        .corner-green { background-color: #00FF66; }
        .bento-border { border: 2px solid #000; box-shadow: 4px 4px 0px #000; }
        
        .app-viewport { height: 100dvh; display: flex; flex-direction: column; width: 100%; }
        .chat-container { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .nav-btn-active { background-color: #000; color: #fff; transform: translateY(-2px); box-shadow: 4px 4px 0px #00FF66; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .thinking { animation: pulse-soft 2s infinite; }
        
        #loading-view, #setup-view, #error-view, #reveal-overlay { 
            position: fixed; inset: 0; background: #F0F0F0; z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; 
        }
        #setup-view { display: none; overflow-y: auto; justify-content: flex-start; padding-top: 40px; }
        #reveal-overlay { display: none; background: rgba(240, 240, 240, 0.98); z-index: 10000; }
        
        .dimension-tag { border: 1px solid #000; font-size: 9px; font-weight: bold; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
        input, textarea { font-size: 16px !important; color: #000; background: #fff; border: 2px solid #000; border-radius: 12px; padding: 12px; } 
        
        .msg-user { background-color: #00FF66; border: 2px solid #000; font-weight: 700; box-shadow: 2px 2px 0px #000; }
        .msg-ai { background-color: #fff; border: 1px solid #ddd; font-style: italic; color: #000; }
        .msg-error { background-color: #fee2e2; border: 1px dashed #ef4444; color: #991b1b; font-size: 11px; font-weight: bold; margin: 10px 0; padding: 12px; border-radius: 12px; width: 100%; }
        
        .status-pill { font-size: 8px; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .status-ok { background: #00FF66; color: #000; }
        .status-fail { background: #ef4444; color: #fff; }
    </style>
</head>
<body>

    <div class="app-viewport">
        
        <!-- OVERLAYS -->
        <div id="loading-view">
            <div class="text-center p-8 bg-white bento-border rounded-3xl max-w-xs w-full">
                <div class="heading-font text-2xl font-bold uppercase italic animate-pulse mb-2">Connecting...</div>
                <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-6 uppercase">The Collective Concierge</p>
                <div id="loading-timeout-msg" class="hidden">
                    <button onclick="showOverlay('setup-view')" class="w-full bg-black text-white py-3 rounded-xl text-[10px] font-bold uppercase tracking-widest shadow-[3px_3px_0px_#00FF66]">Manual Setup</button>
                </div>
            </div>
        </div>

        <div id="reveal-overlay">
            <div class="text-center max-w-sm">
                <div class="heading-font text-4xl font-bold uppercase italic mb-4 leading-none text-black text-center">Vibe Check <br/>Complete.</div>
                <p class="text-sm italic text-gray-600 mb-8 font-medium text-center">A high-conviction alignment has been identified.</p>
                <button onclick="dismissReveal()" class="w-full corner-green border-2 border-black py-4 rounded-xl font-bold uppercase tracking-widest text-sm shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">Enter the Collection</button>
            </div>
        </div>

        <div id="error-view" class="hidden">
            <div class="max-w-md w-full bento-border bg-white p-8 rounded-3xl text-center">
                <div class="heading-font text-3xl font-bold text-red-500 uppercase italic mb-4">Sync Error</div>
                <div id="error-details" class="bg-red-50 p-4 rounded-xl font-mono text-[10px] text-red-800 mb-6 break-all">Initializing...</div>
                <button onclick="localStorage.clear(); location.reload();" class="w-full bg-black text-white py-4 rounded-xl font-bold uppercase text-xs shadow-[4px_4px_0px_#00FF66]">Reset All & Restart</button>
            </div>
        </div>

        <!-- SETUP VIEW -->
        <div id="setup-view">
            <div class="max-w-md mx-auto bento-border bg-white p-6 rounded-3xl w-full">
                <div class="heading-font text-3xl font-bold tracking-tighter uppercase italic mb-6 text-center text-black">
                    the <span class="bg-black text-white px-2">collective.</span>
                </div>
                <h2 class="text-xl font-bold mb-2 italic uppercase tracking-tight text-center text-black leading-none">Cloud Setup</h2>
                
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] font-bold uppercase text-gray-400">Gemini API Key</label>
                            <span id="key-status" class="status-pill">Verify required</span>
                        </div>
                        <input type="password" id="setup-gemini-key" placeholder="Starts with 'AIza...'" class="w-full focus:outline-none text-black">
                        <div id="key-fingerprint" class="text-[8px] text-gray-400 mt-1 uppercase font-bold">No key saved</div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Firebase Config (JSON)</label>
                        <textarea id="setup-firebase-config" rows="4" placeholder='{ "apiKey": "...", ... }' class="w-full focus:outline-none text-black"></textarea>
                    </div>
                    
                    <button onclick="saveSetup()" class="w-full corner-green border-2 border-black py-4 rounded-xl font-bold uppercase tracking-widest text-xs shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:translate-y-0 translate-y-[-2px] transition-all">
                        Update & Launch
                    </button>
                    
                    <button id="test-connection-btn" onclick="testConnection()" class="w-full bg-gray-50 text-black py-3 rounded-xl text-[10px] font-bold uppercase tracking-widest border-2 border-black shadow-[2px_2px_0px_#000] active:translate-y-0">Test connection</button>
                    
                    <div class="pt-4 border-t border-gray-100 flex flex-col gap-2">
                        <button onclick="localStorage.removeItem('collective_gemini_key'); location.reload();" class="text-[8px] font-bold uppercase text-red-500 underline text-center">Clear Only API Key</button>
                        <button onclick="showOverlay('none')" class="text-[8px] font-bold uppercase text-gray-400 text-center underline mt-2">Back to Chat</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN INTERFACE -->
        <div id="app-container" class="max-w-5xl mx-auto w-full h-full flex flex-col hidden">
            
            <!-- ONBOARDING -->
            <div id="onboarding-view" class="hidden max-w-md mx-auto py-4 px-4 text-center w-full">
                <div class="bento-border bg-white rounded-3xl p-6 shadow-xl">
                    <div class="heading-font text-2xl font-bold tracking-tighter uppercase italic mb-6 text-black">
                        the <span class="bg-black text-white px-2">collective.</span>
                    </div>
                    <h2 class="text-lg font-bold mb-6 italic uppercase tracking-tight text-left text-black">Establish member profile</h2>
                    <form id="profile-form" class="space-y-4 text-left">
                        <div>
                            <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Full Name</label>
                            <input type="text" id="p-name" required class="w-full focus:outline-none text-black">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Age</label>
                                <input type="number" id="p-age" required class="w-full focus:outline-none text-black">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-gray-400 block mb-1">Occupation</label>
                                <input type="text" id="p-job" required class="w-full focus:outline-none text-black">
                            </div>
                        </div>
                        <button type="submit" class="w-full corner-green border-2 border-black py-4 rounded-xl font-bold uppercase tracking-widest text-sm shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:translate-y-0 translate-y-[-2px] transition-all mt-4">
                            Start Vibe Check
                        </button>
                    </form>
                </div>
            </div>

            <!-- APP CONTENT -->
            <div id="main-view" class="hidden h-full flex flex-col p-4">
                <header class="flex justify-between items-start mb-4 gap-2">
                    <div class="text-left">
                        <div class="heading-font text-xl font-bold tracking-tighter uppercase italic text-left text-black leading-none">
                            the <span class="bg-black text-white px-1">collective.</span>
                        </div>
                        <p id="user-display-name" class="text-[8px] font-bold uppercase tracking-widest text-gray-400 mt-1 italic text-left leading-none tracking-tighter">Syncing...</p>
                    </div>
                    <div class="flex gap-1 items-center">
                        <button onclick="showOverlay('setup-view')" class="p-2 border-2 border-black rounded-lg bg-white shadow-[2px_2px_0px_#000] active:translate-y-0">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                        <button id="view-concierge-btn" onclick="switchView('concierge')" class="nav-btn-active border-2 border-black px-3 py-1.5 rounded-lg text-[8px] font-bold uppercase tracking-widest transition-all">Concierge</button>
                        <button id="view-archive-btn" onclick="switchView('archive')" class="bg-white border-2 border-black px-3 py-1.5 rounded-lg text-[8px] font-bold uppercase tracking-widest transition-all shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">Matches</button>
                    </div>
                </header>

                <div class="flex-1 flex flex-col md:grid md:grid-cols-12 md:gap-8 overflow-hidden">
                    <div id="soul-sidebar" class="hidden md:block md:col-span-4 space-y-4 mb-4 overflow-y-auto">
                        <div class="bento-border bg-white rounded-2xl p-4">
                            <h2 class="heading-font text-xs font-bold uppercase italic mb-3 text-black">Soul Profile</h2>
                            <div id="vibe-tags" class="flex flex-wrap gap-1 mb-3"></div>
                            <p id="ai-deduction" class="text-[10px] italic leading-relaxed text-gray-500 mb-4 text-left">Waiting for first nuance...</p>
                            <div class="space-y-1 mb-4 border-t border-gray-100 pt-3 text-left">
                                <div class="flex justify-between items-center"><span class="text-[9px] font-bold text-black uppercase tracking-tighter">Comm</span><span id="dim-comm" class="dimension-tag text-black">...</span></div>
                                <div class="flex justify-between items-center my-1"><span class="text-[9px] font-bold text-black uppercase tracking-tighter">Energy</span><span id="dim-energy" class="dimension-tag text-black">...</span></div>
                            </div>
                            <div class="pt-3 border-t border-gray-100">
                                <div class="flex justify-between items-center mb-1"><p class="text-[9px] font-bold uppercase text-gray-400">Trust</p><span id="trust-level" class="text-[9px] font-bold text-black">0%</span></div>
                                <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden border border-black"><div id="trust-bar" class="corner-green h-full w-0 transition-all duration-1000"></div></div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col md:col-span-8 overflow-hidden">
                        <div id="view-concierge" class="flex-1 flex flex-col overflow-hidden">
                            <div id="intro-header" class="hidden bento-border bg-white rounded-t-2xl p-3 border-b-0 flex items-center justify-between">
                                <div class="flex items-center gap-2 text-left">
                                    <div class="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center font-bold text-xs uppercase">S</div>
                                    <h4 class="heading-font text-xs font-bold uppercase italic text-black font-bold">Dialogue: Sam</h4>
                                </div>
                                <button onclick="exitIntro()" class="text-[9px] font-bold uppercase text-gray-400 underline">Exit Room</button>
                            </div>
                            <div id="chat-window" class="chat-container bento-border bg-white rounded-2xl p-4 mb-4 space-y-4 shadow-inner"></div>
                            <div class="relative pb-2">
                                <input type="text" id="user-input" class="w-full rounded-xl p-4 pr-14 focus:outline-none text-sm font-medium text-black bg-white border-2 border-black" placeholder="say something sincere...">
                                <button id="send-btn" class="absolute right-2 top-[calc(50%-4px)] -translate-y-1/2 corner-green p-3 rounded-lg border-2 border-black shadow-[2px_2px_0px_#000] active:translate-y-0 active:shadow-none transition-all">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                </button>
                            </div>
                            <div id="status" class="text-[8px] font-bold uppercase text-gray-400 text-center hidden thinking mb-2 italic">Concierge reflecting...</div>
                        </div>

                        <div id="view-archive" class="hidden flex-1 overflow-y-auto space-y-4 text-left pb-10">
                            <div id="empty-collection" class="border-2 border-dashed border-gray-300 rounded-2xl p-10 flex flex-col items-center justify-center text-center opacity-40">
                                <p class="heading-font text-lg font-bold uppercase italic text-black leading-none mb-1">Collecting...</p>
                                <p class="text-[10px] uppercase font-bold tracking-widest leading-tight text-black tracking-tight italic">Analyzing chapter for alignment.</p>
                            </div>
                            <div id="reveal-card" class="hidden reveal-card bento-border bg-white rounded-2xl p-5">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center font-bold border-2 border-black text-black text-xl uppercase">S</div>
                                    <span class="text-[9px] font-bold bg-emerald-400 px-2 py-1 rounded border border-black uppercase text-black tracking-tighter">94% Alignment</span>
                                </div>
                                <h3 class="heading-font text-2xl font-bold uppercase italic leading-none text-black">Sam.</h3>
                                <p id="match-reasoning" class="text-[11px] text-gray-600 mt-3 leading-relaxed italic"></p>
                                <button id="intro-request-btn" onclick="requestIntro()" class="w-full corner-green border-2 border-black py-3 rounded-xl mt-6 font-bold uppercase tracking-widest text-xs shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] active:translate-y-0 transition-all">Request Intro</button>
                                <div id="invite-status" class="hidden mt-6 text-center p-3 border-2 border-black bg-gray-50 rounded-xl">
                                    <p class="text-[9px] font-bold uppercase tracking-widest animate-pulse text-black font-bold italic">Requesting dialogue...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const DATA_MARKER = "@@@VIBE_DATA@@@";
        let firebaseApp, auth, db, user, profile;
        let inSharedSpace = false;
        let hasTriggeredReveal = false;
        let chatHistory = [];
        
        const appId = 'collective-pilot-01';
        
        // Key Accessor with high-precision cleaning
        const getKeys = () => {
            const rawGemini = localStorage.getItem('collective_gemini_key') || "";
            // Clean the key: remove spaces, line breaks, and non-printable characters
            const cleanGemini = rawGemini.replace(/[\s\t\n\r]/g, '').trim();
            return {
                gemini: cleanGemini,
                firebase: localStorage.getItem('collective_firebase_config')
            };
        };

        window.onload = () => {
            updateKeyFingerprint();
            const keys = getKeys();
            if (!keys.firebase || !keys.gemini) {
                showOverlay('setup-view');
            } else {
                try {
                    bootApp(JSON.parse(keys.firebase));
                } catch(e) { showOverlay('setup-view'); }
            }
        };

        function updateKeyFingerprint() {
            const keys = getKeys();
            const el = document.getElementById('key-fingerprint');
            if (keys.gemini && keys.gemini.length > 5) {
                el.innerText = `Key: ${keys.gemini.length} chars | Ends in ...${keys.gemini.slice(-4)}`;
            } else {
                el.innerText = "No key saved";
            }
        }

        window.showOverlay = (viewId) => {
            const overlays = ['loading-view', 'setup-view', 'error-view', 'reveal-overlay'];
            overlays.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = (id === viewId) ? 'flex' : 'none';
            });
            if (viewId === 'setup-view' || viewId === 'error-view') {
                document.getElementById('app-container').classList.add('hidden');
                const keys = getKeys();
                if (keys.gemini) document.getElementById('setup-gemini-key').value = keys.gemini;
                if (keys.firebase) document.getElementById('setup-firebase-config').value = keys.firebase;
                updateKeyFingerprint();
            }
        };

        window.saveSetup = () => {
            let key = document.getElementById('setup-gemini-key').value.trim();
            // Aggressive cleaning for iPhone paste issues
            key = key.replace(/[\s\t\n\r]/g, '');
            
            let configStr = document.getElementById('setup-firebase-config').value.trim();
            if(!key || !configStr) {
                alert("Please paste both your Gemini Key and Firebase Config.");
                return;
            }
            try {
                if (configStr.includes('{')) configStr = configStr.substring(configStr.indexOf('{'), configStr.lastIndexOf('}') + 1);
                const configObj = new Function(`return ${configStr};`)();
                localStorage.setItem('collective_gemini_key', key);
                localStorage.setItem('collective_firebase_config', JSON.stringify(configObj));
                updateKeyFingerprint();
                location.reload();
            } catch(e) { alert("Invalid Firebase Config format."); }
        };

        async function bootApp(config) {
            try {
                firebaseApp = initializeApp(config);
                auth = getAuth(firebaseApp);
                db = initializeFirestore(firebaseApp, { experimentalForceLongPolling: true });
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => { if (u) { user = u; loadProfile(); } });
            } catch (err) { 
                document.getElementById('error-details').innerText = err.message; 
                showOverlay('error-view'); 
            }
        }

        async function loadProfile() {
            try {
                const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                const snap = await getDoc(ref);
                document.getElementById('app-container').classList.remove('hidden');
                showOverlay('none'); 
                
                if (snap.exists()) {
                    profile = snap.data();
                    updateUI(profile);
                    document.getElementById('onboarding-view').classList.add('hidden');
                    document.getElementById('main-view').classList.remove('hidden');
                    document.getElementById('user-display-name').innerText = `${profile.name} â€¢ ${profile.job}`;
                    setupListener();
                } else { 
                    document.getElementById('onboarding-view').classList.remove('hidden');
                    document.getElementById('main-view').classList.add('hidden');
                }
            } catch(err) { 
                document.getElementById('error-details').innerText = err.message; 
                showOverlay('error-view'); 
            }
        }

        function setupListener() {
            const col = collection(db, 'artifacts', appId, 'users', user.uid, 'messages');
            onSnapshot(col, (snap) => {
                const msgs = [];
                snap.forEach(d => msgs.push(d.data()));
                msgs.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                chatHistory = msgs.map(m => ({ role: m.role, parts: [{ text: m.text }] }));
                renderChat(msgs);
            });
        }

        function safeSet(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerText = text;
        }

        function updateUI(data) {
            if (data.vibeStatus) safeSet('ai-deduction', data.vibeStatus);
            if (typeof data.trust !== 'undefined') {
                const t = data.trust;
                const bar = document.getElementById('trust-bar');
                if (bar) bar.style.width = t + '%';
                safeSet('trust-level', t + '%');
                if (t >= 90 && !hasTriggeredReveal) { showOverlay('reveal-overlay'); hasTriggeredReveal = true; }
            }
            if (data.dimensions) {
                if (data.dimensions.communication) safeSet('dim-comm', data.dimensions.communication);
                if (data.dimensions.energy) safeSet('dim-energy', data.dimensions.energy);
            }
            if (data.tags) {
                const c = document.getElementById('vibe-tags');
                if (c) {
                    c.innerHTML = '';
                    data.tags.forEach(t => { 
                        const s = document.createElement('span'); 
                        s.className = "text-[8px] bg-black text-white px-2 py-0.5 rounded font-bold uppercase italic mr-1 mb-1 tracking-tighter"; 
                        s.innerText = t; 
                        c.appendChild(s); 
                    });
                }
            }
            if (data.matchReasoning) {
                safeSet('match-reasoning', data.matchReasoning);
                const card = document.getElementById('reveal-card');
                const empty = document.getElementById('empty-collection');
                if (card) card.classList.remove('hidden');
                if (empty) empty.classList.add('hidden');
            }
            if (data.inviteSent) {
                const btn = document.getElementById('intro-request-btn');
                const status = document.getElementById('invite-status');
                if (btn) btn.classList.add('hidden');
                if (status) {
                    status.classList.remove('hidden');
                    setTimeout(() => { 
                        status.innerHTML = '<p class="text-[9px] font-bold uppercase tracking-widest text-emerald-600 mb-4">Sam accepted.</p><button onclick="openIntroChat()" class="w-full bg-black text-white py-3 rounded-xl text-[9px] font-bold uppercase shadow-[3px_3px_0px_#00FF66]">Enter Dialogue</button>'; 
                    }, 2000);
                }
            }
        }

        async function callGemini(msg) {
            const keys = getKeys();
            if (!keys.gemini) return { error: "Missing API Key. Check settings." };
            
            const sys = `ROLE: The Collective Concierge. Sharp, extremely brief. 1-2 short sentences max. MISSION: Behavioral vetting. Ask one question at a time. End with ${DATA_MARKER} {"status": "deduction", "tags": ["tag"], "trust": 0-100, "dimensions": {"communication": "...", "energy": "..."}, "matchReasoning": "IF trust >= 90, why Sam fits"}`;
            const body = { contents: chatHistory.concat([{ role: "user", parts: [{ text: msg }] }]), systemInstruction: { parts: [{ text: sys }] }};
            
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keys.gemini}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(body) 
                });
                
                if (!r.ok) {
                    const errObj = await r.json().catch(() => ({}));
                    return { error: `${errObj.error?.message || r.status}` };
                }
                const j = await r.json(); 
                const text = j.candidates?.[0]?.content?.parts?.[0]?.text;
                return text ? { text: text } : { error: "Empty response." };
            } catch(e) { return { error: `Network Failure.` }; }
        }

        window.testConnection = async () => {
            const btn = document.getElementById('test-connection-btn');
            const statusPill = document.getElementById('key-status');
            btn.innerText = "Cleaning & Verifying...";
            
            const res = await callGemini("test connection");
            if (res.error) {
                btn.innerText = "FAILED: Key still invalid";
                btn.style.color = "#ef4444";
                statusPill.innerText = "Invalid";
                statusPill.className = "status-pill status-fail";
                console.error("Gemini Error Details:", res.error);
            } else {
                btn.innerText = "SUCCESS: Linked";
                btn.style.color = "#00FF66";
                statusPill.innerText = "Active";
                statusPill.className = "status-pill status-ok";
            }
            setTimeout(() => { 
                btn.innerText = "Test Connection"; 
                btn.style.color = "#000";
            }, 4000);
        };

        async function handleSend() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text || !user || !db) return;
            if (inSharedSpace) { appendShared('user', text); input.value = ''; return; }
            input.value = '';
            
            const col = collection(db, 'artifacts', appId, 'users', user.uid, 'messages');
            await addDoc(col, { role: 'user', text: text, timestamp: serverTimestamp() });
            
            const statusEl = document.getElementById('status');
            statusEl.classList.remove('hidden');
            const res = await callGemini(text);
            statusEl.classList.add('hidden');

            if (res.error) {
                await addDoc(col, { 
                    role: 'system_error', 
                    text: `CONCIERGE NOTICE: ${res.error}. tap settings icon to check your key.`, 
                    timestamp: serverTimestamp() 
                });
                return;
            }

            if (res.text) {
                const parts = res.text.split(DATA_MARKER);
                const cleanMsg = parts[0].trim();
                await addDoc(col, { role: 'model', text: cleanMsg, timestamp: serverTimestamp() });
                if (parts[1]) {
                    try {
                        const json = JSON.parse(parts[1].trim());
                        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'), { vibeStatus: json.status, trust: json.trust, tags: json.tags, dimensions: json.dimensions || {}, matchReasoning: json.matchReasoning }, { merge: true });
                        loadProfile();
                    } catch(e) {}
                }
            }
        }

        window.requestIntro = async () => {
            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'), { inviteSent: true }, { merge: true });
            loadProfile();
        };

        window.dismissReveal = () => { showOverlay('none'); switchView('archive'); };
        
        window.switchView = (v) => {
            const c = document.getElementById('view-concierge'), a = document.getElementById('view-archive');
            const bc = document.getElementById('view-concierge-btn'), ba = document.getElementById('view-archive-btn');
            const side = document.getElementById('soul-sidebar');
            if (v === 'concierge') { 
                if (c) c.classList.remove('hidden'); if (a) a.classList.add('hidden'); 
                if (bc) bc.classList.add('nav-btn-active'); if (ba) ba.classList.remove('nav-btn-active');
                if(window.innerWidth < 768 && side) side.classList.add('hidden');
            } else { 
                if (c) c.classList.add('hidden'); if (a) a.classList.remove('hidden'); 
                if (ba) ba.classList.add('nav-btn-active'); if (bc) bc.classList.remove('nav-btn-active');
                if (side) side.classList.remove('hidden');
            }
        };

        window.openIntroChat = () => { inSharedSpace = true; document.getElementById('intro-header').classList.remove('hidden'); switchView('concierge'); const win = document.getElementById('chat-window'); win.innerHTML = `<div class="bg-white border italic p-4 rounded-2xl max-w-[85%] text-xs text-left text-black leading-relaxed tracking-tight">sam is here. i've brought you together because ${profile.matchReasoning || 'of a deep alignment.'} i'll let you two take it from here.</div>`; };
        window.exitIntro = async () => { inSharedSpace = false; document.getElementById('intro-header').classList.add('hidden'); loadProfile(); const col = collection(db, 'artifacts', appId, 'users', user.uid, 'messages'); await addDoc(col, { role: 'model', text: "welcome back. how was that dialogue?", timestamp: serverTimestamp() }); };

        function renderChat(msgs) { 
            const w = document.getElementById('chat-window'); if(!w) return; w.innerHTML = ''; 
            msgs.forEach(m => { 
                const d = document.createElement('div'); 
                d.className = m.role === 'user' ? 'flex justify-end' : 'flex justify-start';
                let styleClass = (m.role === 'user') ? 'msg-user' : (m.role === 'system_error' ? 'msg-error' : 'msg-ai');
                d.innerHTML = `<div class="${styleClass} p-3 rounded-xl max-w-[85%] text-[13px] text-left tracking-tight">${m.text}</div>`; 
                w.appendChild(d); 
            }); 
            w.scrollTop = w.scrollHeight; 
        }

        function appendShared(role, text) { 
            const w = document.getElementById('chat-window'); if(!w) return; 
            const d = document.createElement('div'); 
            d.className = role === 'user' ? 'flex justify-end' : 'flex justify-start'; 
            d.innerHTML = `<div class="${role === 'user' ? 'msg-user' : 'msg-ai'} p-3 rounded-xl max-w-[85%] text-[13px] text-left tracking-tight">${text}</div>`; 
            w.appendChild(d); w.scrollTop = w.scrollHeight; 
        }
        
        document.getElementById('profile-form').onsubmit = async (e) => { 
            e.preventDefault(); 
            const p = { name: document.getElementById('p-name').value, age: document.getElementById('p-age').value, job: document.getElementById('p-job').value, trust: 0, createdAt: serverTimestamp() }; 
            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'), p); 
            loadProfile(); 
        };
        
        document.getElementById('send-btn').onclick = handleSend;
        document.getElementById('user-input').onkeypress = (e) => { if(e.key === 'Enter') handleSend(); };
    </script>
</body>
</html>
